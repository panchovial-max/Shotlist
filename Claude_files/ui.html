<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
      font-size: 12px;
      color: #333;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    h2 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: #000;
    }
    
    .status-card {
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .connected .status-indicator {
      background: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }
    
    .disconnected .status-indicator {
      background: #ef4444;
    }
    
    .syncing .status-indicator {
      background: #f59e0b;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    button {
      padding: 10px 16px;
      background: #000;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #333;
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .button-secondary {
      background: #fff;
      color: #000;
      border: 1px solid #e5e5e5;
    }
    
    .button-secondary:hover {
      background: #f5f5f5;
    }
    
    .button-danger {
      background: #ef4444;
    }
    
    .button-danger:hover {
      background: #dc2626;
    }
    
    .info-section {
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }
    
    .info-label {
      color: #6b7280;
      font-size: 11px;
    }
    
    .info-value {
      font-weight: 500;
      font-size: 11px;
    }
    
    .selection-info {
      text-align: center;
      padding: 8px;
      background: #fef3c7;
      border-radius: 4px;
      color: #92400e;
      font-size: 11px;
    }
    
    .divider {
      height: 1px;
      background: #e5e5e5;
      margin: 8px 0;
    }
    
    .server-input {
      padding: 8px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 11px;
      width: 100%;
    }
    
    .server-input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .button-group {
      display: flex;
      gap: 8px;
    }
    
    .button-group button {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîÑ Localhost Sync</h2>
    
    <div id="status" class="status-card disconnected">
      <span class="status-indicator"></span>
      <span id="statusText">Not connected to server</span>
    </div>
    
    <div class="info-section">
      <div class="info-row">
        <span class="info-label">Server:</span>
        <span class="info-value" id="serverUrl">localhost:8000</span>
      </div>
      <div class="info-row">
        <span class="info-label">Selection:</span>
        <span class="info-value" id="selectionCount">0 items</span>
      </div>
      <div class="info-row">
        <span class="info-label">Last Sync:</span>
        <span class="info-value" id="lastSync">Never</span>
      </div>
    </div>
    
    <div class="divider"></div>
    
    <div id="serverConfig" style="display: none;">
      <input 
        type="text" 
        id="serverInput" 
        class="server-input" 
        placeholder="Enter server URL (e.g., localhost:8000)"
        value="localhost:8000"
      />
    </div>
    
    <button id="connectBtn">Connect to Server</button>
    
    <div class="button-group">
      <button id="syncBtn" disabled>Sync Selection</button>
      <button id="autoSyncBtn" class="button-secondary" disabled>Auto Sync: OFF</button>
    </div>
    
    <div class="divider"></div>
    
    <div class="button-group">
      <button id="settingsBtn" class="button-secondary">‚öôÔ∏è Settings</button>
      <button id="closeBtn" class="button-secondary">Close</button>
    </div>
  </div>

  <script>
    // Elements
    const statusEl = document.getElementById('status');
    const statusTextEl = document.getElementById('statusText');
    const connectBtn = document.getElementById('connectBtn');
    const syncBtn = document.getElementById('syncBtn');
    const autoSyncBtn = document.getElementById('autoSyncBtn');
    const closeBtn = document.getElementById('closeBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const serverConfigEl = document.getElementById('serverConfig');
    const serverInputEl = document.getElementById('serverInput');
    const serverUrlEl = document.getElementById('serverUrl');
    const selectionCountEl = document.getElementById('selectionCount');
    const lastSyncEl = document.getElementById('lastSync');
    
    // State
    let connected = false;
    let autoSync = false;
    let serverUrl = 'localhost:8000';
    let selectionCount = 0;
    
    // Functions
    function updateStatus(status, text) {
      statusEl.className = `status-card ${status}`;
      statusTextEl.textContent = text;
    }
    
    function formatTime() {
      const now = new Date();
      return now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    async function testConnection() {
      try {
        const response = await fetch(`http://${serverUrl}/ping`, {
          method: 'GET',
          mode: 'cors'
        });
        return response.ok;
      } catch (error) {
        console.error('Connection test failed:', error);
        return false;
      }
    }
    
    async function syncData(data) {
      try {
        updateStatus('syncing', 'Syncing...');
        
        const response = await fetch(`http://${serverUrl}/sync`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Origin': 'figma-plugin'
          },
          mode: 'cors',
          body: JSON.stringify({
            timestamp: new Date().toISOString(),
            selection: data
          })
        });
        
        if (response.ok) {
          updateStatus('connected', `Connected to ${serverUrl}`);
          lastSyncEl.textContent = formatTime();
          
          parent.postMessage({ 
            pluginMessage: { 
              type: 'notify',
              message: `‚úì Synced ${data.length} items`
            } 
          }, '*');
          
          return true;
        }
        return false;
      } catch (error) {
        console.error('Sync failed:', error);
        updateStatus('disconnected', 'Sync failed');
        return false;
      }
    }
    
    // Event Listeners
    connectBtn.addEventListener('click', async () => {
      if (connected) {
        // Disconnect
        connected = false;
        autoSync = false;
        updateStatus('disconnected', 'Disconnected');
        connectBtn.textContent = 'Connect to Server';
        syncBtn.disabled = true;
        autoSyncBtn.disabled = true;
        autoSyncBtn.textContent = 'Auto Sync: OFF';
        autoSyncBtn.classList.add('button-secondary');
      } else {
        // Try to connect
        updateStatus('syncing', 'Connecting...');
        
        if (await testConnection()) {
          connected = true;
          updateStatus('connected', `Connected to ${serverUrl}`);
          connectBtn.textContent = 'Disconnect';
          syncBtn.disabled = selectionCount === 0;
          autoSyncBtn.disabled = false;
        } else {
          updateStatus('disconnected', 'Connection failed. Is server running?');
        }
      }
    });
    
    syncBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'sync-selection' } }, '*');
    });
    
    autoSyncBtn.addEventListener('click', () => {
      autoSync = !autoSync;
      if (autoSync) {
        autoSyncBtn.textContent = 'Auto Sync: ON';
        autoSyncBtn.classList.remove('button-secondary');
        parent.postMessage({ 
          pluginMessage: { 
            type: 'notify',
            message: 'Auto sync enabled'
          } 
        }, '*');
      } else {
        autoSyncBtn.textContent = 'Auto Sync: OFF';
        autoSyncBtn.classList.add('button-secondary');
        parent.postMessage({ 
          pluginMessage: { 
            type: 'notify',
            message: 'Auto sync disabled'
          } 
        }, '*');
      }
    });
    
    settingsBtn.addEventListener('click', () => {
      const isVisible = serverConfigEl.style.display !== 'none';
      serverConfigEl.style.display = isVisible ? 'none' : 'block';
      
      if (!isVisible) {
        serverInputEl.focus();
      }
    });
    
    serverInputEl.addEventListener('change', (e) => {
      serverUrl = e.target.value;
      serverUrlEl.textContent = serverUrl;
      if (connected) {
        connectBtn.click(); // Disconnect
      }
    });
    
    closeBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
    });
    
    // Handle messages from the plugin
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'selection-data' && connected) {
        await syncData(msg.data);
      }
      
      if (msg.type === 'selection-changed') {
        selectionCount = msg.count;
        selectionCountEl.textContent = `${msg.count} item${msg.count !== 1 ? 's' : ''}`;
        syncBtn.disabled = !connected || msg.count === 0;
        
        // Auto sync if enabled
        if (autoSync && connected && msg.count > 0) {
          parent.postMessage({ pluginMessage: { type: 'sync-selection' } }, '*');
        }
      }
      
      if (msg.type === 'no-selection') {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'notify',
            message: msg.message
          } 
        }, '*');
      }
      
      if (msg.type === 'show-settings') {
        serverConfigEl.style.display = 'block';
        serverInputEl.focus();
      }
      
      if (msg.type === 'stop-sync') {
        if (connected) {
          connectBtn.click();
        }
      }
      
      if (msg.type === 'start-sync') {
        if (!connected) {
          connectBtn.click();
        }
      }
    };
    
    // Request initial document info
    parent.postMessage({ pluginMessage: { type: 'get-document-info' } }, '*');
  </script>
</body>
</html>